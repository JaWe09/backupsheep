{% extends "console/_master.html" %}
{% block title %}{{ heading }}{% endblock %}
{% block meta_title %}{{ heading }}{% endblock %}
{% block meta_description %}{{ heading }}{% endblock %}
{% block meta_keywords %}{{ heading }}{% endblock %}
{% block page_class %}page_console console-page sb-l-o sb-r-c{% endblock %}
{% block content %}
    <div>
        <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <div class="relative bg-white pt-5 px-4 pb-12 sm:pt-6 sm:px-6 shadow rounded-lg overflow-hidden">
                <dt>
                    <div class="absolute bg-indigo-500 rounded-md p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                    </div>
                    <p class="ml-16 text-sm font-medium text-gray-700 truncate">Total</p>
                </dt>
                <dd class="ml-16 pb-6 flex items-baseline sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-700">
                        {{ total_connections }}
                    </p>

                    <div class="absolute bottom-0 inset-x-0 bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="text-sm">
                            <a href="{% url 'console:connections:index' %}" class="font-medium text-indigo-600 hover:text-indigo-500"> View All</a>
                        </div>
                    </div>
                </dd>
            </div>

            <div class="relative bg-white pt-5 px-4 pb-12 sm:pt-6 sm:px-6 shadow rounded-lg overflow-hidden">
                <dt>
                    <div class="absolute bg-indigo-500 rounded-md p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                        </svg>
                    </div>
                    <p class="ml-16 text-sm font-medium text-gray-700 truncate">Cloud</p>
                </dt>
                <dd class="ml-16 pb-6 flex items-baseline sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-700">
                        {{ total_connections_cloud }}
                    </p>
                    <div class="absolute bottom-0 inset-x-0 bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="text-sm">
                            {% if connection_type == "cloud" %}
                                <a href="{% url 'console:connections:index' %}" class="font-medium text-indigo-600 hover:text-indigo-500">Reset Filter<span class="sr-only"> Reset Filter</span></a>
                            {% else %}
                                <a href="{% url 'console:connections:index' %}?type=cloud" class="font-medium text-indigo-600 hover:text-indigo-500"> Filter<span class="sr-only"> Filter</span></a>
                            {% endif %}
                        </div>
                    </div>
                </dd>
            </div>

            <div class="relative bg-white pt-5 px-4 pb-12 sm:pt-6 sm:px-6 shadow rounded-lg overflow-hidden">
                <dt>
                    <div class="absolute bg-indigo-500 rounded-md p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                        </svg>
                    </div>
                    <p class="ml-16 text-sm font-medium text-gray-700 truncate">Websites</p>
                </dt>
                <dd class="ml-16 pb-6 flex items-baseline sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-700">
                        {{ total_connections_website }}
                    </p>

                    <div class="absolute bottom-0 inset-x-0 bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="text-sm">
                            {% if connection_type == "website" %}
                                <a href="{% url 'console:connections:index' %}" class="font-medium text-indigo-600 hover:text-indigo-500">Reset Filter<span class="sr-only"> Reset Filter</span></a>
                            {% else %}
                                <a href="{% url 'console:connections:index' %}?type=website" class="font-medium text-indigo-600 hover:text-indigo-500"> Filter<span class="sr-only"> Filter</span></a>
                            {% endif %}
                        </div>
                    </div>
                </dd>
            </div>
            <div class="relative bg-white pt-5 px-4 pb-12 sm:pt-6 sm:px-6 shadow rounded-lg overflow-hidden">
                <dt>
                    <div class="absolute bg-indigo-500 rounded-md p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                        </svg>
                    </div>
                    <p class="ml-16 text-sm font-medium text-gray-700 truncate">Databases</p>
                </dt>
                <dd class="ml-16 pb-6 flex items-baseline sm:pb-7">
                    <p class="text-2xl font-semibold text-gray-700">
                        {{ total_connections_database }}
                    </p>

                    <div class="absolute bottom-0 inset-x-0 bg-gray-50 px-4 py-4 sm:px-6">
                        <div class="text-sm">
                            {% if connection_type == "database" %}
                                <a href="{% url 'console:connections:index' %}" class="font-medium text-indigo-600 hover:text-indigo-500">Reset Filter<span class="sr-only"> Reset Filter</span></a>
                            {% else %}
                                <a href="{% url 'console:connections:index' %}?type=database" class="font-medium text-indigo-600 hover:text-indigo-500"> Filter<span class="sr-only"> Filter</span></a>
                            {% endif %}
                        </div>
                    </div>
                </dd>
            </div>
        </dl>
    </div>
    <div class="pb-5 border-b border-gray-200 mt-16">
        <div class="-ml-2 -mt-2 flex flex-wrap items-baseline">
            {{ connection_type|default:""|title }} Connections
            {% if connection_type == "cloud" %}
                <p class="ml-2 mt-1 text-sm text-gray-700 truncate">{{ connection_type }} backups are stored on-site in your hosting account.</p>
            {% elif connection_type == "website" or connection_type == "database" %}
                <p class="ml-2 mt-1 text-sm text-gray-700 truncate">{{ connection_type }} backups are stored off-site.</p>
            {% endif %}
        </div>
    </div>
    <div x-data="connectionList()">
        <div class="flex flex-col mt-6">
            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="py-2 align-middle min-w-full sm:px-6 lg:px-8">
                    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                        <table id="section-connections" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Name
                                </th>

                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Nodes
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Region
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Actions</span>
                                </th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            {% for connection in page.object_list %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                {% if connection.type == "cloud" %}
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 rounded-full text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                                    </svg>
                                                {% elif connection.type == "volume" %}
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 rounded-full text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                                    </svg>
                                                {% elif connection.type == "website" %}
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 rounded-full text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                                                    </svg>
                                                {% elif connection.type == "database" %}
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 rounded-full text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                                    </svg>
                                                {% endif %}
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-700">
                                                    {{ connection.name }}
                                                </div>
                                                <div class="text-sm text-gray-700">
                                                    {{ connection.integration.name }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>


                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-700">{{ connection.total_nodes }}</div>
                                    </td>

                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-700">
                                            <div class="overflow-auto flex items-center">
                                                <div class="">
                                                    <img src="{{ connection.location.image_url }}" alt="{{ connection.location.location }}" class="max-h-6 mr-2">
                                                </div>
                                                <div class="">
                                                    {{ connection.location.location }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-sm text-gray-700">
                                            Region IP - {{ connection.location.ip_address }}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if connection.status == 1 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            {{ connection.get_status_display }}
                                        </span>
                                        {% elif connection.status == 3 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ connection.get_status_display }}
                                        </span>
                                        {% elif connection.status == 4 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                            {{ connection.get_status_display }}
                                        </span>
                                        {% elif connection.status == 6 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                            {{ connection.get_status_display }}
                                        </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                            {{ connection.get_status_display }}
                                        </span>
                                        {% endif %}
                                    </td>

                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        {% if connection.status == 5 %}
                                            <button @click="resumeConnection('{{ connection.id }}', '{{ connection.integration.code }}')" type="button"
                                                    class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                Undo
                                            </button>
                                        {% else %}
                                            <span class="relative z-0 inline-flex shadow-sm rounded-md">
                                                  <button @click="openConnectionModal('{{ connection.id }}', '{{ connection.integration.code }}', '{{ connection.location.id }}')" type="button" class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium
                                                  text-gray-700 hover:bg-gray-50
                                                  focus:z-10
                                                  focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                    Modify
                                                  </button>
                                                {% if connection.status == 1 %}
                                                    <button @click="pauseConnection('{{ connection.id }}')" type="button"
                                                            class="-ml-px relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                        Pause
                                                    </button>
                                                {% elif connection.status == 4 %}
                                                    <button @click="resumeConnection('{{ connection.id }}')" type="button"
                                                            class="-ml-px relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                        Resume
                                                    </button>
                                                {% endif %}

                                                <button @click="deleteConnection('{{ connection.id }}')" type="button"
                                                        class="-ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10
                                                      focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                                        Delete
                                                    </button>
                                            </span>
                                        {% endif %}

                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <nav class="border-t border-gray-200 px-4 flex items-center justify-between sm:px-0 mt-4">
            <div class="-mt-px w-0 flex-1 flex">
                {% if page.has_previous %}
                    <a href="{% url 'console:connections:index' %}?p_no={{ page.previous_page_number }}&p_size={{ page.paginator.per_page }}&#section-connections"
                       class="border-t-2 border-transparent pt-4 pr-1 inline-flex items-center text-sm font-medium text-gray-700 hover:text-gray-700 hover:border-gray-300">
                        <svg class="mr-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Previous
                    </a>
                {% endif %}
            </div>
            <div class="hidden md:-mt-px md:flex">
                {% for page_no in elided_page_range %}
                    <!-- Current: "border-indigo-500 text-indigo-600", Default: "border-transparent text-gray-700 hover:text-gray-700 hover:border-gray-300" -->
                    {% if page_no == "…" %}
                        <a class="{% if page.number ==  page_no %}border-indigo-500 text-indigo-600{% else %}border-transparent text-gray-700 hover:text-gray-700 hover:border-gray-300{% endif %} border-t-2 pt-4 px-4 inline-flex items-center text-sm font-medium">
                            {{ page_no }}
                        </a>
                    {% else %}
                        <a href="{% url 'console:connections:index' %}?p_no={{ page_no }}&p_size={{ page.paginator.per_page }}&#section-connections"
                           class="{% if page.number ==  page_no %}border-indigo-500 text-indigo-600{% else %}border-transparent text-gray-700 hover:text-gray-700 hover:border-gray-300{% endif %} border-t-2 pt-4 px-4 inline-flex items-center text-sm font-medium">
                            {{ page_no }}
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="-mt-px w-0 flex-1 flex justify-end">
                {% if page.has_next %}
                    <a href="{% url 'console:connections:index' %}?p_no={{ page.next_page_number }}&p_size={{ page.paginator.per_page }}&#section-connections"
                       class="border-t-2 border-transparent pt-4 pl-1 inline-flex items-center text-sm font-medium text-gray-700 hover:text-gray-700 hover:border-gray-300">
                        Next
                        <svg class="ml-3 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </a>
                {% endif %}
            </div>
        </nav>

        <div x-show="openConnection" style="display: none;" class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div x-show="openConnection"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                <div x-show="openConnection"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                    <div>
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-500">
                            <svg x-show="loading" class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <svg x-show="!loading" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                            </svg>
                        </div>
                        <div x-show="!loading" class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg leading-6 font-medium text-gray-700" id="modal-title">
                                Modify Connection
                            </h3>
                        </div>
                        <div x-show="loading" class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg leading-6 font-medium text-gray-700" id="modal-title">
                                Loading connection details...
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-700">
                                    Fetching connection details for <br/><strong x-text="connection?.name"></strong>
                                </p>
                            </div>
                        </div>
                        <div x-show="!loading" class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                            <div class="sm:col-span-6">
                                <label for="name" class="block text-sm font-medium text-gray-700">
                                    Name
                                </label>
                                <div class="mt-1">
                                    <input x-model="connection.name" type="text" name="name" id="name" autocomplete="name"
                                           class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <p x-show="connectionErrors?.name" class="mt-2 text-sm text-red-600" id="name-error" x-text="connectionErrors?.name"></p>
                                </div>
                            </div>

                            <div class="sm:col-span-6">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    Endpoint
                                </label>
                                <p class="mt-1 text-sm text-gray-700">
                                    Endpoint is location from where your backups will be executed. <span x-show="connection.location"><br/>You must whitelist IPv4 <strong x-text="connection.location?.ip_address"></strong> and IPv6(if supported) <strong x-text="connection.location?.ip_address_v6"></strong></span>
                                </p>
                                <div class="relative mt-2">
                                    <button @click="toggleEndpointDropdown()"
                                            type="button"
                                            class="relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            aria-haspopup="listbox" aria-expanded="true" aria-labelledby="listbox-label">
                                        <img :src="connection.location?.image_url" class="max-h-6 mr-2  float-left">

                                        <span class="block truncate" x-text="connection.location?.location||'--Choose Endpoint--'"></span>
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <!-- Heroicon name: solid/selector -->
                                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                  <path fill-rule="evenodd"
                                                        d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                        clip-rule="evenodd"></path>
                                                </svg>
                                              </span>
                                    </button>

                                    <ul
                                            x-show="openEndpoint"
                                            @click.self="toggleEndpointDropdown()"
                                            x-transition:enter=""
                                            x-transition:enter-start=""
                                            x-transition:enter-end=""
                                            x-transition:leave="transition ease-in duration-100"
                                            x-transition:leave-start="opacity-100"
                                            x-transition:leave-end="opacity-0"
                                            class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm" tabindex="-1" role="listbox"
                                            aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3">
                                        <!--
                                          Select option, manage highlight styles based on mouseenter/mouseleave and keyboard navigation.

                                          Highlighted: "text-white bg-indigo-600", Not Highlighted: "text-gray-700"
                                        -->
                                        <template x-for="(endpoint, index) in endpoints">
                                            <li
                                                    @click="connection.location = endpoint;toggleEndpointDropdown()"
                                                    @mouseenter="endpointActiveIndex = index" @mouseleave="endpointActiveIndex = null"
                                                    :class="{ 'text-white bg-indigo-600': endpointActiveIndex === index, 'text-gray-700': !(endpointActiveIndex === index) }"
                                                    class="cursor-default select-none relative py-2 pl-8 pr-4" id="listbox-option-0" role="option">
                                                    <span class="font-normal block truncate">
                                                        <img :src="endpoint?.image_url" class="max-h-6 mr-2  float-left"> <span x-text="endpoint.location"></span>
                                                    </span>

                                                <span
                                                        x-show="connection.location?.id === endpoint?.id"
                                                        :class="{ 'text-indigo-600': (connection.location?.id === endpoint?.id) && (endpointActiveIndex !== index), 'text-white': (!(connection.location === endpoint) || (endpointActiveIndex === index)) }"
                                                        class="text-indigo-600 absolute inset-y-0 left-0 flex items-center pl-1.5">
                                                      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                      </svg>
                                                    </span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                                <p x-show="connectionErrors.endpoint" class="mt-2 text-sm text-red-600" id="email-error" x-text="connectionErrors.endpoint"></p>
                            </div>

                            <div class="sm:col-span-6" x-show="selectAWSRegions">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    <span x-text="connection.integration?.name"></span> Region
                                </label>
                                <div class="relative mt-2">
                                    <button @click="toggleAWSRegionDropdown()"
                                            type="button"
                                            class="relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            aria-haspopup="listbox" aria-expanded="true" aria-labelledby="listbox-label">
                                        <span class="block truncate" x-text="selectedAuth.region?.name||'--Choose AWS Region--'"></span>
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <!-- Heroicon name: solid/selector -->
                                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                  <path fill-rule="evenodd"
                                                        d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                        clip-rule="evenodd"></path>
                                                </svg>
                                              </span>
                                    </button>

                                    <ul
                                            x-show="openAWSRegion"
                                            @click.self="toggleAWSRegionDropdown()"
                                            x-transition:enter=""
                                            x-transition:enter-start=""
                                            x-transition:enter-end=""
                                            x-transition:leave="transition ease-in duration-100"
                                            x-transition:leave-start="opacity-100"
                                            x-transition:leave-end="opacity-0"
                                            class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm" tabindex="-1" role="listbox"
                                            aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3">

                                        <template x-for="(region, index) in awsRegions">
                                            <li
                                                    @click="selectedAuth.region = region;toggleAWSRegionDropdown()"
                                                    @mouseenter="awsRegionActiveIndex = index" @mouseleave="awsRegionActiveIndex = null"
                                                    :class="{ 'text-white bg-indigo-600': awsRegionActiveIndex === index, 'text-gray-700': !(awsRegionActiveIndex === index) }"
                                                    class="cursor-default select-none relative py-2 pl-8 pr-4" id="listbox-option-0" role="option">
                                                    <span class="font-normal block truncate">
                                                        <span x-text="region.name"></span>
                                                    </span>

                                                <span
                                                        x-show="selectedAuth.region?.id === region?.id"
                                                        :class="{ 'text-indigo-600': (selectedAuth.region?.id === region?.id) && (awsRegionActiveIndex !== index), 'text-white': (!(selectedAuth.region === region) || (awsRegionActiveIndex === index)) }"
                                                        class="text-indigo-600 absolute inset-y-0 left-0 flex items-center pl-1.5">
                                                      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                      </svg>
                                                    </span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                                <p x-show="connectionErrors.region" class="mt-2 text-sm text-red-600" id="email-error" x-text="connectionErrors.region"></p>
                            </div>


                            <div class="sm:col-span-6" x-show="selectedAuth?.access_key">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    Access Key
                                </label>
                                <div class="mt-1">
                                    <input x-model="selectedAuth.access_key" type="text" name="name" id="name" autocomplete="given-name"
                                           class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <p x-show="connectionErrors?.access_key" class="mt-2 text-sm text-red-600" id="name-error" x-text="connectionErrors?.access_key"></p>
                                </div>
                            </div>

                            <div class="sm:col-span-6" x-show="selectedAuth?.secret_key">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    Secret Key
                                </label>
                                <div class="mt-1">
                                    <input x-model="selectedAuth.secret_key" type="text" name="name" id="name" autocomplete="given-name"
                                           class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <p x-show="connectionErrors?.secret_key" class="mt-2 text-sm text-red-600" id="name-error" x-text="connectionErrors?.secret_key"></p>
                                </div>
                            </div>

                            <div class="sm:col-span-6" x-show="connection?.integration?.code === 'hetzner'">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    API Key
                                </label>
                                <div class="mt-1">
                                    <input x-model="selectedAuth.api_key" type="text" name="api_key" id="api_key" autocomplete="given-api_key"
                                           class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <p x-show="connectionErrors?.api_key" class="mt-2 text-sm text-red-600" id="name-error" x-text="connectionErrors?.api_key"></p>
                                </div>
                            </div>

                            <div class="sm:col-span-6" x-show="connection?.integration?.code === 'vultr'">
                                <label for="first-name" class="block text-sm font-medium text-gray-700">
                                    API Key
                                </label>
                                <div class="mt-1">
                                    <input x-model="selectedAuth.api_key" type="text" name="api_key" id="api_key" autocomplete="given-api_key"
                                           class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                    <p x-show="connectionErrors?.api_key" class="mt-2 text-sm text-red-600" id="name-error" x-text="connectionErrors?.api_key"></p>
                                </div>
                            </div>

                            <div class="sm:col-span-6">
                                <label for="about" class="block text-sm font-medium text-gray-700">
                                    Notes
                                </label>
                                <div class="mt-1">
                                    <textarea x-model="connection.notes" id="about" name="about" rows="3" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                                    <p x-show="connectionErrors?.notes" class="mt-2 text-sm text-red-600" id="email-error" x-text="connectionErrors?.notes"></p>
                                </div>
                                <p class="mt-2 text-sm text-gray-700">Optional notes about the connection.</p>
                            </div>
                        </div>
                    </div>

                    <div x-show="!loading" class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                        <button @click="saveConnection()" type="button"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                            <span>Modify Connection</span>
                        </button>
                        <button @click="closeConnectionModal()" type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('connectionList', () => ({
                openConnection: false,
                openEndpoint: false,
                openAWSRegion: false,
                selectAWSRegions: false,
                endpointActiveIndex: null,
                awsRegionActiveIndex: null,
                connection: {},
                endpoints: [],
                awsRegions: [],
                notes: null,
                loading: null,
                selectedAuth: {},
                connectionErrors: {
                    name: null,
                    notes: null,
                    endpoint: null,
                    region: null,
                },
                async openConnectionModal(connection_id, integration_code, location_id) {
                    this.connection = {};
                    this.notes = null;
                    this.loading = true;
                    this.openConnection = true;

                    this.getEndpoints(integration_code);

                    if (integration_code === "aws" || integration_code === "aws_rds" || integration_code === "lightsail") {
                        await this.getAWSRegions(integration_code);
                        this.selectAWSRegions = true;
                    }

                    let url = "/api/v1/connections/" + integration_code + "/" + connection_id + "/?" + new URLSearchParams({
                        location: location_id,
                    });

                    /**
                     * We need to get details of schedule so we will make GET call.
                     * @type {Response}
                     */
                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'GET',
                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            this.loading = false;
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            this.connectionErrors = json;
                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        {#Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});#}
                        this.connection = json;
                        this.selectedAuth = this.connection["auth_" + integration_code];
                        this.loading = false;
                        {#this.closeConnectionModal();#}
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                        {#this.closeConnectionModal();#}
                    });

                },
                async saveConnection() {
                    this.loading = true;

                    let url = "/api/proxy/connections/" + this.connection.integration.code + "/" + this.connection.id + "/?" + new URLSearchParams({
                        location: this.connection.location.id,
                    });

                    let data = {
                        name: this.connection.name,
                        notes: this.connection.notes,
                        location: this.connection.location?.id,
                    };

                    data["auth_" + this.connection.integration.code] = this.selectedAuth;

                    if (this.connection.integration.code === "aws" || this.connection.integration.code === "aws_rds" || this.connection.integration.code === "lightsail") {
                        data["auth_" + this.connection.integration.code].region = data["auth_" + this.connection.integration.code].region.id;
                    }

                    /**
                     * We need to get details of schedule so we will make GET call.
                     * @type {Response}
                     */
                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'PATCH',
                        body: JSON.stringify(data)

                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            this.loading = false;
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            this.connectionErrors = json;
                            json.detail = this.connectionErrors["auth_" + this.connection.integration.code]?.non_field_errors[0];
                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});
                        this.loading = false;
                        this.closeConnectionModal();
                        location.reload();
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                    });

                },
                async getEndpoints(integration_code) {
                    let url = "/api/v1/connections/" + integration_code + "/endpoints/?";

                    /**
                     * We need to get details of schedule so we will make GET call.
                     * @type {Response}
                     */
                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'GET',
                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            this.loading = false;
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            this.connectionErrors = json;
                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        {#Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});#}
                        this.endpoints = json;
                        {#this.closeConnectionModal();#}
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                        {#this.closeConnectionModal();#}
                    });
                },
                async getAWSRegions(integration_code) {
                    let url = "/api/v1/connections/" + integration_code + "/regions/?";

                    /**
                     * We need to get details of schedule so we will make GET call.
                     * @type {Response}
                     */
                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'GET',
                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            this.loading = false;
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            this.connectionErrors = json;
                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        {#Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});#}
                        this.awsRegions = json;
                        {#this.closeConnectionModal();#}
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                        {#this.closeConnectionModal();#}
                    });
                },
                async pauseConnection(connection_id) {
                    this.loading = true;

                    let url = "/api/v1/connections/" + connection_id + "/pause/";

                    let data = {
                        notes: this.notes,
                        status: 4,
                    }

                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify(data)
                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});
                        location.reload();
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                    });
                },

                async resumeConnection(connection_id) {
                    this.loading = true;

                    let url = "/api/v1/connections/" + connection_id + "/resume/";

                    let data = {
                        notes: this.notes,
                        status: 1,
                    }

                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify(data)
                    }).then(async (response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});
                        location.reload();
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                    });
                },

                async deleteConnection(connection_id) {
                    this.loading = true;

                    let url = "/api/v1/connections/" + connection_id + "/delete/";

                    let data = {
                        notes: this.notes,
                    }

                    let response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify(data)
                    }).then(async (response) => {
                        if (response.status === 200) {
                            return {"detail": "Connection will be deleted soon."};
                        } else {
                            let json;try {json = await response.json();} catch (exception_var) {json = {detail: response.status + " - " + response.statusText + ". Please contact support."};}

                            throw new Error(json.detail);
                        }
                    }).then((json) => {
                        Alpine.store('notifications').items.push({show: true, success: true, heading: 'Success!', details: json.detail});
                        location.reload();
                    }).catch((error) => {
                        Alpine.store('notifications').items.push({show: true, error: true, heading: 'Error!', details: error.message});
                    });
                },

                toggleEndpointDropdown() {
                    this.openEndpoint = !this.openEndpoint;
                    this.endpointActiveIndex = null;
                },
                toggleAWSRegionDropdown() {
                    this.openAWSRegion = !this.openAWSRegion;
                    this.awsRegionActiveIndex = null;
                },
                closeConnectionModal() {
                    this.openEndpoint = false;
                    this.endpointActiveIndex = null;
                    this.openConnection = false;
                    this.selectAWSRegions = false;
                    this.connection = {};
                    this.selectedAuth = {};
                    this.connectionErrors = {
                        name: null,
                        notes: null,
                        endpoint: null,
                        region: null,
                    };
                },
            }));
        });
    </script>
{% endblock %}
